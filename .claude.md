# Claude Code Guide for vizgres

## Project Overview

**vizgres** is a fast, keyboard-driven PostgreSQL TUI client written in Rust.

### Key Technologies

- **Language**: Rust 2024 edition, MSRV 1.85
- **TUI**: ratatui 0.28 + crossterm 0.28
- **Database**: tokio-postgres (PostgreSQL only, no trait abstraction)
- **Async**: tokio
- **CLI**: clap 4
- **Clipboard**: arboard

### Architecture

Elm-like architecture with unidirectional data flow:
1. Terminal events → `App::handle_event()` → returns `Action`
2. Main loop executes `Action` (connect, query, quit, etc.)
3. DB results come back as `AppEvent` via `tokio::sync::mpsc`
4. `render(&app, &mut frame)` draws the UI from App state

### Module Map

| Module | Purpose |
|--------|---------|
| `main.rs` | Terminal init, event loop, action executor |
| `app.rs` | App state, event→action routing, focus management |
| `db/postgres.rs` | PostgreSQL connection, query execution, schema loading |
| `db/types.rs` | CellValue, DataType, QueryResults, Row, ColumnDef |
| `db/schema.rs` | SchemaTree, Schema, Table, Column |
| `ui/render.rs` | Top-level render function |
| `ui/layout.rs` | Panel layout calculation (AppLayout struct) |
| `ui/tree.rs` | Schema tree browser (flattened items, expand/collapse) |
| `ui/editor.rs` | Multi-line SQL editor (lines-based) |
| `ui/results.rs` | Results table with cell-level navigation |
| `ui/inspector.rs` | Cell value inspector (right-side split panel) |
| `ui/command_bar.rs` | Command input bar |
| `ui/theme.rs` | Colors and styles |
| `commands/parser.rs` | `:command` parsing |
| `config/connections.rs` | Connection profiles + URL parsing |
| `error.rs` | Error hierarchy (VizgresError, DbError, ConfigError, CommandError) |

### Key Design Decisions

- **No DatabaseProvider trait**: `PostgresProvider` used directly. Postgres-only for now.
- **Component trait**: Each UI panel implements `handle_key()` + `render()`.
- **Manual table rendering**: Results viewer renders cells manually (not ratatui Table widget) to support cell-level highlight.
- **Inspector as split panel**: Not an overlay. 40% right-side split of results area.

## Working with the Code

### Running

```bash
# Build and run
cargo run -- postgres://user:pass@localhost/mydb

# Run without database
cargo run

# Tests
cargo test
```

### Code Quality

```bash
cargo fmt
cargo clippy --all-targets -- -D warnings
cargo test
```

### Adding a Command

1. Add variant to `Command` enum in `src/commands/parser.rs`
2. Add match arm in `parse_command()`
3. Handle in `App::execute_command()` in `src/app.rs`
4. Write tests

### Adding a UI Component

1. Create `src/ui/<component>.rs`
2. Implement `Component` trait (`handle_key` + `render`)
3. Add module to `src/ui/mod.rs`
4. Wire into `App` struct and key handling in `app.rs`
5. Add to render function in `ui/render.rs`

### Error Handling

- Use `thiserror` for typed errors (DbError, ConfigError, CommandError)
- Use `?` operator with `.map_err()` for context
- Never use `unwrap()` in production code
